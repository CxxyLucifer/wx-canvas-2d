!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.WxCanvas2d=e():t.WxCanvas2d=e()}(self,(function(){return(()=>{"use strict";var t={867:(t,e,i)=>{i.r(e),i.d(e,{default:()=>r});const s=wx.getSystemInfoSync(),h={100:"生成图片失败",101:"获取设置信息失败",102:"保存图片到相册失败",103:"授权失败",104:"用户拒绝授权",105:"用户前往授权页",106:"获取图片信息失败",107:"加载图片失败"},o=function(t){return{code:t,msg:h[t]}},r=class{constructor(){this.query=null,this.bgColor=null,this.radius=null,this.component=null,this.canvas=null,this.ctx=null,this.dpr=null,this.rootWidth=null,this.fontFamily="sans-serif",this.startTime=Date.now(),this.debugger=!1}create(t){return new Promise(((e,i)=>{const h={query:"",rootWidth:375,...t};h.query||i(new Error("[WxCanvas2d] 'query' is empty.")),this.query=h.query,this.bgColor=h.bgColor,this.component=h.component,this.radius=h.radius,(this.component?wx.createSelectorQuery().in(this.component):wx.createSelectorQuery()).select(this.query).fields({node:!0,size:!0}).exec((t=>{if(!t[0])return!1;const i=t[0].node,o=i.getContext("2d"),r=s.pixelRatio;this.canvas=i,this.ctx=o,this.dpr=r,this.rootWidth=h.rootWidth,this.canvas.width=t[0].width*this.dpr,this.canvas.height=t[0].height*this.dpr,e()}))}))}clear(){this.ctx.clearRect(0,0,this.xDpr(this.canvas.width),this.xDpr(this.canvas.height)),this.radius&&(this.drawRectPath({x:0,y:0,width:this.canvas.width/s.screenWidth/this.dpr*this.rootWidth,height:this.canvas.height/s.screenWidth/this.dpr*this.rootWidth,radius:this.radius}),this.ctx.clip()),this.bgColor&&(this.ctx.fillStyle=this.bgColor,this.ctx.fillRect(0,0,this.xDpr(this.canvas.width),this.xDpr(this.canvas.height)))}xDpr(t){return t*this.dpr*s.screenWidth/this.rootWidth}draw(t){return new Promise(((e,i)=>{this.startTime=Date.now();const{series:s}=t;(this.component?wx.createSelectorQuery().in(this.component):wx.createSelectorQuery()).select(this.query).fields({node:!0,size:!0}).exec((t=>{if(!t[0])return!1;this.canvas.width=t[0].width*this.dpr,this.canvas.height=t[0].height*this.dpr,this.clear();const h=s.map((t=>({...t,zIndex:t.zIndex||0}))).sort(((t,e)=>t.zIndex-e.zIndex)),o={rect:(...t)=>this.drawRect(...t),image:(...t)=>this.drawImage(...t),text:(...t)=>this.drawText(...t),line:(...t)=>this.drawLine(...t)},r=(t=0)=>{if(t<h.length){const e=h[t];o[e.type]?(this.styleClear(),o[e.type](e).then((()=>{this.debugLogout(`绘制成功 [${e.type}] (${t+1}/${h.length})`),r(++t)})).catch((t=>{this.debugLogout("绘制失败"),i(t)}))):(this.debugLogout(`未知类型 type: '${e.type}'`,"error"),r(++t))}else this.debugLogout(`绘制完成 (${Date.now()-this.startTime}ms)`),e()};this.debugLogout("开始绘制"),r()}))}))}styleClear(){this.ctx.setTextAlign="left",this.ctx.textBaseline="top",this.ctx.fillStyle="#000",this.ctx.font=`${this.xDpr(12*this.rootWidth/s.screenWidth)}px ${this.fontFamily}`,this.ctx.lineCap="butt",this.ctx.setLineDash([1,0]),this.ctx.lineDashOffset=0,this.ctx.lineJoin="bevel",this.ctx.lineWidth=this.xDpr(1),this.ctx.strokeStyle="#000"}drawRect(t){return new Promise(((e,i)=>{const s={x:0,y:0,width:0,height:0,color:"",bgColor:"",radius:0,...t};this.ctx.strokeStyle=s.color,this.ctx.fillStyle=s.bgColor,this.drawRectPath({x:s.x,y:s.y,width:s.width,height:s.height,radius:s.radius}),s.color&&this.ctx.stroke(),s.bgColor&&this.ctx.fill(),e()}))}drawRectPath(t){const e={x:0,y:0,width:0,height:0,radius:0,...t},{x:i,y:s,width:h,height:o,radius:r}=e,n={top:1.5*Math.PI,right:0,bottom:.5*Math.PI,left:Math.PI},l=[[n.left,n.top],[n.top,n.right],[n.right,n.bottom],[n.bottom,n.left]],c=[[i+r,s+r].map((t=>this.xDpr(t))),[i+h-r,s+r].map((t=>this.xDpr(t))),[i+h-r,s+o-r].map((t=>this.xDpr(t))),[i+r,s+o-r].map((t=>this.xDpr(t)))];this.ctx.beginPath(),Array(4).fill().forEach(((t,e)=>{this.ctx.arc(...c[e],this.xDpr(r),...l[e])})),this.ctx.closePath()}drawImage(t){const e={url:"",x:0,y:0,width:0,height:0,mode:"scaleToFill",radius:0,blur:0,...t};return new Promise(((t,i)=>{const{url:s,x:h,y:r,width:n,height:l,mode:c,radius:a,blur:d}=e,x=this.canvas.createImage();x.src=s,x.onload=()=>{wx.getImageInfo({src:s,success:e=>{const i=e.width,s=e.height,o=n/l;let d=1,g=1;"aspectFit"===c?(d=e.width/e.height<o?n/e.width*e.height/l:1,g=e.width/e.height>o?l/e.height*e.width/n:1):"aspectFill"===c&&(d=e.width/e.height>o?n/e.width*e.height/l:1,g=e.width/e.height<o?l/e.height*e.width/n:1);const p={scaleToFill:[0,0,i,s],aspectFit:[(e.width-e.width*d)/2,(e.height-e.height*g)/2,e.width*d,e.height*g],aspectFill:[(e.width-e.width*d)/2,(e.height-e.height*g)/2,e.width*d,e.height*g],widthFix:[],top:[(i-n)/2,0,n,l],bottom:[(i-n)/2,s-l,n,l],center:[(i-n)/2,(s-l)/2,n,l],left:[0,(s-l)/2,n,l],right:[i-n,(s-l)/2,n,l],"top left":[0,0,n,l],"top right":[i-n,0,n,l],"bottom left":[0,s-l,n,l],"bottom right":[i-n,s-l,n,l]};a&&(this.ctx.save(),this.drawRectPath({x:h,y:r,width:n,height:l,radius:a}),this.ctx.clip()),this.ctx.drawImage(x,...p[c]||[],this.xDpr(h)||0,this.xDpr(r)||0,this.xDpr(n||e.width),this.xDpr(l||e.height)),a&&this.ctx.restore(),t()},fail:()=>{i(o(106))}})},x.onerror=()=>{i(o(107))}}))}drawText(t){return new Promise(((e,i)=>{const s={x:0,y:0,color:"#000",fontSize:12,fontWeight:"",width:1/0,baseline:"top",align:"left",...t,text:String(t.text)||"",ellipsis:Math.max(+t.ellipsis,0),lineHeight:t.lineHeight||t.fontSize||12};let h=0,o=0,r=[];this.ctx.setTextAlign=s.align,this.ctx.textBaseline=s.baseline,this.ctx.fillStyle=s.color,this.ctx.font=`${s.fontWeight} ${this.xDpr(s.fontSize)}px ${this.fontFamily}`,s.text.split("").forEach(((t,e)=>{const i=s.text.slice(h,e+1);this.ctx.measureText(i).width<this.xDpr(s.width)?r[o]=i:(h=e,o++)})),s.ellipsis&&r.length>s.ellipsis&&(r=r.slice(0,s.ellipsis),r[s.ellipsis-1]=r[s.ellipsis-1].slice(0,-1)+"..."),r.forEach(((t,e)=>{const i=s.y+s.lineHeight*e+(s.lineHeight-s.fontSize)/2;this.ctx.fillText(t,this.xDpr(s.x),this.xDpr(i))})),e()}))}drawLine(t){return new Promise(((e,i)=>{const s={lineStyle:{cap:"butt",join:"bevel",offset:0,dash:[1,0],color:"#000",width:1,...t.lineStyle},line:t.line||[]};this.ctx.lineCap=s.lineStyle.cap,this.ctx.setLineDash(s.lineStyle.dash.map((t=>this.xDpr(t)))),this.ctx.lineDashOffset=this.xDpr(s.lineStyle.offset),this.ctx.lineJoin=s.lineStyle.join,this.ctx.lineWidth=this.xDpr(s.lineStyle.width),this.ctx.strokeStyle=s.lineStyle.color,s.line.forEach(((t,e)=>{e?(this.ctx.lineTo(...t.point.map((t=>this.xDpr(t)))),this.ctx.stroke()):(this.ctx.beginPath(),this.ctx.moveTo(...t.point.map((t=>this.xDpr(t)))))})),e()}))}saveToAlbum(t){return new Promise(((e,i)=>{const s={x:0,y:0,width:0,height:0,destWidth:0,destHeight:0,modalOption:{},...t};wx.canvasToTempFilePath({x:s.x,y:s.y,width:s.width,height:s.height,destWidth:this.xDpr(s.destWidth),destHeight:this.xDpr(s.destHeight),canvas:this.canvas,success:t=>{const r=t.tempFilePath;var n;(n="writePhotosAlbum",new Promise(((t,e)=>{wx.getSetting({success(e){const i=t=>({settings:e,code:t});void 0!==e.authSetting["scope."+n]&&!0!==e.authSetting["scope."+n]?t(i(1)):void 0===e.authSetting["scope."+n]?t(i(2)):t(i(3))},fail(t){e(t)}})}))).then((t=>{1===t.code?wx.showModal({title:s.modalOption.title||"获取权限",content:s.modalOption.content||"请前往开启相册权限",success:s.modalOption.success||(t=>{t.confirm?(wx.openSetting(),this.debugLogout(h[105]+" (105)","error"),i(o(105))):t.cancel&&(this.debugLogout(h[104]+" (104)","error"),i(o(104)))})}):[2,3].includes(t.code)&&function(t){return new Promise(((e,i)=>{wx.saveImageToPhotosAlbum({filePath:t,success:t=>{e()},fail:t=>{i(t)}})}))}(r).then((t=>{this.debugLogout("保存图片到相册成功"),e()})).catch((()=>{this.debugLogout(h[102]+" (102)","error"),i(o(102))}))})).catch((()=>{this.debugLogout(h[101]+" (101)","error"),i(o(101))}))},fail:()=>{this.debugLogout(h[100]+" (100)","error"),i(o(100))}})}))}debugLogout(...t){this.debugger&&function(t,e="info"){if(!t)return;const i=function(e,i){console.log("%cWxCanvas2d%c"+t,`\n            color: ${e.color};\n            background-color: ${e.bgColor};\n            padding: 1px 4px;\n            border-radius: 4px 0 0 4px;\n        `,`\n            color: ${i.color};\n            background-color: ${i.bgColor};\n            padding: 1px 4px;\n            border-radius: 0 4px 4px 0;\n        `)};"devtools"===s.brand?"info"===e?i({color:"#004B1C",bgColor:"#2BDC70"},{color:"#084BBC",bgColor:"#81A9F0"}):"error"===e?i({color:"#006727",bgColor:"#2BDC70"},{color:"#D82E2E",bgColor:"#FFB2B2"}):console.log("WxCanvas2d: "+t):console.debug("WxCanvas2d: "+t)}(...t)}}}},e={};function i(s){if(e[s])return e[s].exports;var h=e[s]={exports:{}};return t[s](h,h.exports,i),h.exports}return i.d=(t,e)=>{for(var s in e)i.o(e,s)&&!i.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i(867)})()}));