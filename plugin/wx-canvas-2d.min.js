!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.WxCanvas2d=e():t.WxCanvas2d=e()}(self,(function(){return(()=>{"use strict";var t={181:(t,e,i)=>{function o(t){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}i.r(e),i.d(e,{default:()=>a});var s=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],r=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];var h=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.r=0,this.g=0,this.b=0,this.a=0,this.next=null};console.log({stackblurCanvasRGB:function(t,e,i,n,l,c){if(!(isNaN(c)||c<1)){c|=0;var a=function(t,e,i,s,r){if("string"==typeof t&&(t=document.getElementById(t)),!t||"object"!==o(t)||!("getContext"in t))throw new TypeError("Expecting canvas with `getContext` method in processCanvasRGB(A) calls!");var h=t.getContext("2d");try{return h.getImageData(e,i,s,r)}catch(t){throw new Error("unable to access image data: "+t)}}(t,e,i,n,l);a=function(t,e,i,o,n,l){for(var c,a=t.data,d=2*l+1,x=o-1,g=n-1,u=l+1,p=u*(u+1)/2,f=new h,w=f,y=1;y<d;y++)w=w.next=new h,y===u&&(c=w);w.next=f;for(var b,m,v=null,S=null,D=s[l],C=r[l],P=0,W=0,T=0;T<n;T++){var I=a[W],L=a[W+1],F=a[W+2],$=u*I,B=u*L,E=u*F,O=p*I,R=p*L,j=p*F;w=f;for(var z=0;z<u;z++)w.r=I,w.g=L,w.b=F,w=w.next;for(var k=0,q=0,A=0,H=1;H<u;H++)b=W+((x<H?x:H)<<2),O+=(w.r=I=a[b])*(m=u-H),R+=(w.g=L=a[b+1])*m,j+=(w.b=F=a[b+2])*m,k+=I,q+=L,A+=F,w=w.next;v=f,S=c;for(var M=0;M<o;M++)a[W]=O*D>>C,a[W+1]=R*D>>C,a[W+2]=j*D>>C,O-=$,R-=B,j-=E,$-=v.r,B-=v.g,E-=v.b,b=P+((b=M+l+1)<x?b:x)<<2,O+=k+=v.r=a[b],R+=q+=v.g=a[b+1],j+=A+=v.b=a[b+2],v=v.next,$+=I=S.r,B+=L=S.g,E+=F=S.b,k-=I,q-=L,A-=F,S=S.next,W+=4;P+=o}for(var Q=0;Q<o;Q++){var G=a[W=Q<<2],J=a[W+1],N=a[W+2],_=u*G,K=u*J,U=u*N,V=p*G,X=p*J,Y=p*N;w=f;for(var Z=0;Z<u;Z++)w.r=G,w.g=J,w.b=N,w=w.next;for(var tt=0,et=0,it=0,ot=1,st=o;ot<=l;ot++)W=st+Q<<2,V+=(w.r=G=a[W])*(m=u-ot),X+=(w.g=J=a[W+1])*m,Y+=(w.b=N=a[W+2])*m,tt+=G,et+=J,it+=N,w=w.next,ot<g&&(st+=o);W=Q,v=f,S=c;for(var rt=0;rt<n;rt++)a[b=W<<2]=V*D>>C,a[b+1]=X*D>>C,a[b+2]=Y*D>>C,V-=_,X-=K,Y-=U,_-=v.r,K-=v.g,U-=v.b,b=Q+((b=rt+u)<g?b:g)*o<<2,V+=tt+=v.r=a[b],X+=et+=v.g=a[b+1],Y+=it+=v.b=a[b+2],v=v.next,_+=G=S.r,K+=J=S.g,U+=N=S.b,tt-=G,et-=J,it-=N,S=S.next,W+=o}return t}(a,0,0,n,l,c),t.getContext("2d").putImageData(a,e,i)}}});const n=wx.getSystemInfoSync(),l={100:"生成图片失败",101:"获取设置信息失败",102:"保存图片到相册失败",103:"授权失败",104:"用户拒绝授权",105:"用户前往授权页",106:"获取图片信息失败",107:"加载图片失败"},c=function(t){return{code:t,msg:l[t]}},a=class{constructor(){this.query=null,this.bgColor=null,this.radius=null,this.component=null,this.canvas=null,this.ctx=null,this.dpr=null,this.rootWidth=null,this.fontFamily="sans-serif",this.startTime=Date.now(),this.debugger=!1}create(t){return new Promise(((e,i)=>{const o={query:"",rootWidth:375,...t};o.query||i(new Error("[WxCanvas2d] 'query' is empty.")),this.query=o.query,this.bgColor=o.bgColor,this.component=o.component,this.radius=o.radius,(this.component?wx.createSelectorQuery().in(this.component):wx.createSelectorQuery()).select(this.query).fields({node:!0,size:!0}).exec((t=>{if(!t[0])return!1;const i=t[0].node,s=i.getContext("2d"),r=n.pixelRatio;this.canvas=i,this.ctx=s,this.dpr=r,this.rootWidth=o.rootWidth,this.canvas.width=t[0].width*this.dpr,this.canvas.height=t[0].height*this.dpr,e()}))}))}clear(){this.ctx.clearRect(0,0,this.xDpr(this.canvas.width),this.xDpr(this.canvas.height)),this.radius&&(this.drawRectPath({x:0,y:0,width:this.canvas.width/n.screenWidth/this.dpr*this.rootWidth,height:this.canvas.height/n.screenWidth/this.dpr*this.rootWidth,radius:this.radius}),this.ctx.clip()),this.bgColor&&(this.ctx.fillStyle=this.bgColor,this.ctx.fillRect(0,0,this.xDpr(this.canvas.width),this.xDpr(this.canvas.height)))}xDpr(t){return t*this.dpr*n.screenWidth/this.rootWidth}draw(t){return new Promise(((e,i)=>{this.startTime=Date.now();const{series:o}=t;(this.component?wx.createSelectorQuery().in(this.component):wx.createSelectorQuery()).select(this.query).fields({node:!0,size:!0}).exec((t=>{if(!t[0])return!1;this.canvas.width=t[0].width*this.dpr,this.canvas.height=t[0].height*this.dpr,this.clear();const s=o.map((t=>({...t,zIndex:t.zIndex||0}))).sort(((t,e)=>t.zIndex-e.zIndex)),r={rect:(...t)=>this.drawRect(...t),image:(...t)=>this.drawImage(...t),text:(...t)=>this.drawText(...t),line:(...t)=>this.drawLine(...t)},h=(t=0)=>{if(t<s.length){const e=s[t];r[e.type]?(this.styleClear(),r[e.type](e).then((()=>{this.debugLogout(`绘制成功 [${e.type}] (${t+1}/${s.length})`),h(++t)})).catch((t=>{this.debugLogout("绘制失败"),i(t)}))):(this.debugLogout(`未知类型 type: '${e.type}'`,"error"),h(++t))}else this.debugLogout(`绘制完成 (${Date.now()-this.startTime}ms)`),e()};this.debugLogout("开始绘制"),h()}))}))}styleClear(){this.ctx.setTextAlign="left",this.ctx.textBaseline="top",this.ctx.fillStyle="#000",this.ctx.font=`${this.xDpr(12*this.rootWidth/n.screenWidth)}px ${this.fontFamily}`,this.ctx.lineCap="butt",this.ctx.setLineDash([1,0]),this.ctx.lineDashOffset=0,this.ctx.lineJoin="bevel",this.ctx.lineWidth=this.xDpr(1),this.ctx.strokeStyle="#000"}drawRect(t){return new Promise(((e,i)=>{const o={x:0,y:0,width:0,height:0,color:"",bgColor:"",radius:0,...t};this.ctx.strokeStyle=o.color,this.ctx.fillStyle=o.bgColor,this.drawRectPath({x:o.x,y:o.y,width:o.width,height:o.height,radius:o.radius}),o.color&&this.ctx.stroke(),o.bgColor&&this.ctx.fill(),e()}))}drawRectPath(t){const e={x:0,y:0,width:0,height:0,radius:0,...t},{x:i,y:o,width:s,height:r,radius:h}=e,n={top:1.5*Math.PI,right:0,bottom:.5*Math.PI,left:Math.PI},l=[[n.left,n.top],[n.top,n.right],[n.right,n.bottom],[n.bottom,n.left]],c=[[i+h,o+h].map((t=>this.xDpr(t))),[i+s-h,o+h].map((t=>this.xDpr(t))),[i+s-h,o+r-h].map((t=>this.xDpr(t))),[i+h,o+r-h].map((t=>this.xDpr(t)))];this.ctx.beginPath(),Array(4).fill().forEach(((t,e)=>{this.ctx.arc(...c[e],this.xDpr(h),...l[e])})),this.ctx.closePath()}drawImage(t){const e={url:"",x:0,y:0,width:0,height:0,mode:"scaleToFill",radius:0,...t};return new Promise(((t,i)=>{const{url:o,x:s,y:r,width:h,height:n,mode:l,radius:a}=e,d=this.canvas.createImage();d.src=o,d.onload=()=>{wx.getImageInfo({src:o,success:e=>{const i=e.width,o=e.height,c=h/n;let x=1,g=1;"aspectFit"===l?(x=e.width/e.height<c?h/e.width*e.height/n:1,g=e.width/e.height>c?n/e.height*e.width/h:1):"aspectFill"===l&&(x=e.width/e.height>c?h/e.width*e.height/n:1,g=e.width/e.height<c?n/e.height*e.width/h:1);const u={scaleToFill:[0,0,i,o],aspectFit:[(e.width-e.width*x)/2,(e.height-e.height*g)/2,e.width*x,e.height*g],aspectFill:[(e.width-e.width*x)/2,(e.height-e.height*g)/2,e.width*x,e.height*g],widthFix:[],top:[(i-h)/2,0,h,n],bottom:[(i-h)/2,o-n,h,n],center:[(i-h)/2,(o-n)/2,h,n],left:[0,(o-n)/2,h,n],right:[i-h,(o-n)/2,h,n],"top left":[0,0,h,n],"top right":[i-h,0,h,n],"bottom left":[0,o-n,h,n],"bottom right":[i-h,o-n,h,n]};a&&(this.ctx.save(),this.drawRectPath({x:s,y:r,width:h,height:n,radius:a}),this.ctx.clip()),this.ctx.drawImage(d,...u[l]||[],this.xDpr(s)||0,this.xDpr(r)||0,this.xDpr(h||e.width),this.xDpr(n||e.height)),a&&this.ctx.restore(),t()},fail:()=>{i(c(106))}})},d.onerror=()=>{i(c(107))}}))}drawText(t){return new Promise(((e,i)=>{const o={x:0,y:0,color:"#000",fontSize:12,fontWeight:"",width:1/0,baseline:"top",align:"left",...t,text:String(t.text)||"",ellipsis:Math.max(+t.ellipsis,0),lineHeight:t.lineHeight||t.fontSize||12};let s=0,r=0,h=[];this.ctx.setTextAlign=o.align,this.ctx.textBaseline=o.baseline,this.ctx.fillStyle=o.color,this.ctx.font=`${o.fontWeight} ${this.xDpr(o.fontSize)}px ${this.fontFamily}`,o.text.split("").forEach(((t,e)=>{const i=o.text.slice(s,e+1);this.ctx.measureText(i).width<this.xDpr(o.width)?h[r]=i:(s=e,r++)})),o.ellipsis&&h.length>o.ellipsis&&(h=h.slice(0,o.ellipsis),h[o.ellipsis-1]=h[o.ellipsis-1].slice(0,-1)+"..."),h.forEach(((t,e)=>{const i=o.y+o.lineHeight*e+(o.lineHeight-o.fontSize)/2;this.ctx.fillText(t,this.xDpr(o.x),this.xDpr(i))})),e()}))}drawLine(t){return new Promise(((e,i)=>{const o={lineStyle:{cap:"butt",join:"bevel",offset:0,dash:[1,0],color:"#000",width:1,...t.lineStyle},line:t.line||[]};this.ctx.lineCap=o.lineStyle.cap,this.ctx.setLineDash(o.lineStyle.dash.map((t=>this.xDpr(t)))),this.ctx.lineDashOffset=this.xDpr(o.lineStyle.offset),this.ctx.lineJoin=o.lineStyle.join,this.ctx.lineWidth=this.xDpr(o.lineStyle.width),this.ctx.strokeStyle=o.lineStyle.color,o.line.forEach(((t,e)=>{e?(this.ctx.lineTo(...t.point.map((t=>this.xDpr(t)))),this.ctx.stroke()):(this.ctx.beginPath(),this.ctx.moveTo(...t.point.map((t=>this.xDpr(t)))))})),e()}))}saveToAlbum(t){return new Promise(((e,i)=>{const o={x:0,y:0,width:0,height:0,destWidth:0,destHeight:0,modalOption:{},...t};wx.canvasToTempFilePath({x:o.x,y:o.y,width:o.width,height:o.height,destWidth:this.xDpr(o.destWidth),destHeight:this.xDpr(o.destHeight),canvas:this.canvas,success:t=>{const s=t.tempFilePath;var r;(r="writePhotosAlbum",new Promise(((t,e)=>{wx.getSetting({success(e){const i=t=>({settings:e,code:t});void 0!==e.authSetting["scope."+r]&&!0!==e.authSetting["scope."+r]?t(i(1)):void 0===e.authSetting["scope."+r]?t(i(2)):t(i(3))},fail(t){e(t)}})}))).then((t=>{1===t.code?wx.showModal({title:o.modalOption.title||"获取权限",content:o.modalOption.content||"请前往开启相册权限",success:o.modalOption.success||(t=>{t.confirm?(wx.openSetting(),this.debugLogout(l[105]+" (105)","error"),i(c(105))):t.cancel&&(this.debugLogout(l[104]+" (104)","error"),i(c(104)))})}):[2,3].includes(t.code)&&function(t){return new Promise(((e,i)=>{wx.saveImageToPhotosAlbum({filePath:t,success:t=>{e()},fail:t=>{i(t)}})}))}(s).then((t=>{this.debugLogout("保存图片到相册成功"),e()})).catch((()=>{this.debugLogout(l[102]+" (102)","error"),i(c(102))}))})).catch((()=>{this.debugLogout(l[101]+" (101)","error"),i(c(101))}))},fail:()=>{this.debugLogout(l[100]+" (100)","error"),i(c(100))}})}))}debugLogout(...t){this.debugger&&function(t,e="info"){if(!t)return;const i=function(e,i){console.log("%cWxCanvas2d%c"+t,`\n            color: ${e.color};\n            background-color: ${e.bgColor};\n            padding: 1px 4px;\n            border-radius: 4px 0 0 4px;\n        `,`\n            color: ${i.color};\n            background-color: ${i.bgColor};\n            padding: 1px 4px;\n            border-radius: 0 4px 4px 0;\n        `)};"devtools"===n.brand?"info"===e?i({color:"#004B1C",bgColor:"#2BDC70"},{color:"#084BBC",bgColor:"#81A9F0"}):"error"===e?i({color:"#006727",bgColor:"#2BDC70"},{color:"#D82E2E",bgColor:"#FFB2B2"}):console.log("WxCanvas2d: "+t):console.debug("WxCanvas2d: "+t)}(...t)}}}},e={};function i(o){if(e[o])return e[o].exports;var s=e[o]={exports:{}};return t[o](s,s.exports,i),s.exports}return i.d=(t,e)=>{for(var o in e)i.o(e,o)&&!i.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i(181)})()}));